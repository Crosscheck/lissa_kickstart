<?xml version="1.0" encoding="UTF-8"?>

<project name="LISSA Kickstart" default="build">
  <property file="build.default.properties" description="Default build configuration"/>
  <property file="build.properties" description="Local build configuration overrides"/>

  <property name="builddir" value="${phing.dir}/build"/>

  <target name="build" depends="install" description="Run drush make and drush site-install"/>

  <target name="clean" description="Clean build artifacts">
    <delete dir="${builddir}"/>
  </target>

  <target name="clean-docroot">
    <chmod dir="${basedir}/docroot/sites/${sites.subdir}" perm="755"/>
    <delete dir="${basedir}/docroot"/>
  </target>

  <target name="clean-src" depends="clean-docroot" description="Clean source code"/>

  <target name="clean-all" depends="clean,clean-src" description="Clean build artifacts and source code"/>

  <target name="prepare">
    <mkdir dir="${builddir}" />
    <mkdir dir="${builddir}/logs" />
  </target>

  <target name="drush-make" unless="drush.nomake" description="Run drush make">
    <delete dir="${builddir}/docroot"/>
    <!-- Run drush make into ./build/drupal -->
    <exec executable="${drush}">
      <arg value="make"/>
      <arg value="--nocolor"/>
      <arg value="--prepare-install"/>
      <arg value="${phing.dir}/${drush.makefile}"/>
      <arg value="${builddir}/docroot"/>
    </exec>
    <!-- Rsync the build into ./docroot -->
    <exec executable="${rsync}">
      <arg value="-aqc"/>
      <arg value="--delete"/>
      <arg value="--exclude=sites/*/settings*.php"/>
      <arg value="--exclude=sites/*/files"/>
      <arg value="${builddir}/docroot/"/>
      <arg value="${basedir}/docroot"/>
    </exec>
  </target>

  <target name="install" depends="drush-make" unless="drush.noinstall" description="Run drush site-install">
    <exec executable="${drush}" dir="${basedir}/docroot">
      <arg value="site-install"/>
      <arg value="-y"/>
      <arg value="--nocolor"/>
      <arg value="--db-url=${db.url}"/>
      <arg value="--site-name=${site.name}"/>
      <arg value="--site-mail=${site.mail}"/>
      <arg value="--account-name=${account.name}"/>
      <arg value="--account-pass=${account.pass}"/>
      <arg value="--account-mail=${account.mail}"/>
      <arg value="--sites-subdir=${sites.subdir}"/>
      <arg value="${drupal.profile}"/>
    </exec>
  </target>

  <target name="uninstall" description="Run drush sql-drop">
    <exec executable="${drush}" dir="${basedir}/docroot">
      <arg value="sql-drop"/>
      <arg value="-y"/>
      <arg value="--nocolor"/>
      <arg value="--db-url=${db.url}"/>
    </exec>
  </target>
</project>
